name: Terraform Security Gate (OPA)

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  TF_VERSION: 1.6.6
  OPA_VERSION: 0.63.0

jobs:
  terraform-security:
    name: Terraform + OPA Policy Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan (JSON)
        run: |
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Run OPA Policy Checks
        run: |
          opa eval \
            --fail-defined \
            --format pretty \
            --input tfplan.json \
            --data terraform-modules/opa/policies \
            "data.terraform.security.deny"
